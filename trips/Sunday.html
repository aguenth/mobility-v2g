{% extends "global/Page.html" %}
{% load otree static %}

{% block content %}
<h3>Trip Diary: Sunday</h3>
<br>
<br>
<form method="post">

    <div class="inline-label-input">
        <label>{{ form.sun_first_trip.label }}</label>
        {{ form.sun_first_trip }}
    </div>
    <br><br>

    <table id="additional-trips-table">
        <thead id="additional-trips-table-thead" >
            <tr>
                <th>Destination</th>
                <th>Start Time</th>
                <th>Distance (km)</th>
                <th>Duration (mins)</th>
            </tr>
        </thead>
        <tbody>
            <tr id="additional_trip_1" style="display: {% if initial_values.sun_additional_trip_1 %}table-row{% else %}none{% endif %};">
                <td>{{ form.sun_additional_trip_1 }}</td>
                <td>{{ form.sun_start_time_1 }}</td>
                <td>{{ form.sun_distance_1 }}</td>
                <td>{{ form.sun_duration_1 }}</td>
                <td><button type="button" class="remove-trip styled-red-button" data-trip-id="1">-</button></td>
            </tr>
            <tr id="additional_trip_2" style="display: {% if initial_values.sun_additional_trip_2 %}table-row{% else %}none{% endif %};">
                <td>{{ form.sun_additional_trip_2 }}</td>
                <td>{{ form.sun_start_time_2 }}</td>
                <td>{{ form.sun_distance_2 }}</td>
                <td>{{ form.sun_duration_2 }}</td>
                <td><button type="button" class="remove-trip styled-red-button" data-trip-id="2">-</button></td>
            </tr>
            <tr id="additional_trip_3" style="display: {% if initial_values.sun_additional_trip_3 %}table-row{% else %}none{% endif %};">
                <td>{{ form.sun_additional_trip_3 }}</td>
                <td>{{ form.sun_start_time_3 }}</td>
                <td>{{ form.sun_distance_3 }}</td>
                <td>{{ form.sun_duration_3 }}</td>
                <td><button type="button" class="remove-trip styled-red-button" data-trip-id="3">-</button></td>
            </tr>
            <tr id="additional_trip_4" style="display: {% if initial_values.sun_additional_trip_4 %}table-row{% else %}none{% endif %};">
                <td>{{ form.sun_additional_trip_4 }}</td>
                <td>{{ form.sun_start_time_4 }}</td>
                <td>{{ form.sun_distance_4 }}</td>
                <td>{{ form.sun_duration_4 }}</td>
                <td><button type="button" class="remove-trip styled-red-button" data-trip-id="4">-</button></td>
            </tr>
            <tr id="additional_trip_5" style="display: {% if initial_values.sun_additional_trip_5 %}table-row{% else %}none{% endif %};">
                <td>{{ form.sun_additional_trip_5 }}</td>
                <td>{{ form.sun_start_time_5 }}</td>
                <td>{{ form.sun_distance_5 }}</td>
                <td>{{ form.sun_duration_5 }}</td>
                <td><button type="button" class="remove-trip styled-red-button" data-trip-id="5">-</button></td>
            </tr>
            <tr id="additional_trip_6" style="display: {% if initial_values.sun_additional_trip_6 %}table-row{% else %}none{% endif %};">
                <td>{{ form.sun_additional_trip_6 }}</td>
                <td>{{ form.sun_start_time_6 }}</td>
                <td>{{ form.sun_distance_6 }}</td>
                <td>{{ form.sun_duration_6 }}</td>
                <td><button type="button" class="remove-trip styled-red-button" data-trip-id="6">-</button></td>
            </tr>
            <tr id="additional_trip_7" style="display: {% if initial_values.sun_additional_trip_7 %}table-row{% else %}none{% endif %};">
                <td>{{ form.sun_additional_trip_7 }}</td>
                <td>{{ form.sun_start_time_7 }}</td>
                <td>{{ form.sun_distance_7 }}</td>
                <td>{{ form.sun_duration_7 }}</td>
                <td><button type="button" class="remove-trip styled-red-button" data-trip-id="7">-</button></td>
            </tr>
            <tr id="additional_trip_8" style="display: {% if initial_values.sun_additional_trip_8 %}table-row{% else %}none{% endif %};">
                <td>{{ form.sun_additional_trip_8 }}</td>
                <td>{{ form.sun_start_time_8 }}</td>
                <td>{{ form.sun_distance_8 }}</td>
                <td>{{ form.sun_duration_8 }}</td>
                <td><button type="button" class="remove-trip styled-red-button" data-trip-id="8">-</button></td>
            </tr>
            <tr id="additional_trip_9" style="display: {% if initial_values.sun_additional_trip_9 %}table-row{% else %}none{% endif %};">
                <td>{{ form.sun_additional_trip_9 }}</td>
                <td>{{ form.sun_start_time_9 }}</td>
                <td>{{ form.sun_distance_9 }}</td>
                <td>{{ form.sun_duration_9 }}</td>
                <td><button type="button" class="remove-trip styled-red-button" data-trip-id="9">-</button></td>
            </tr>
            <tr id="additional_trip_10" style="display: {% if initial_values.sun_additional_trip_10 %}table-row{% else %}none{% endif %};">
                <td>{{ form.sun_additional_trip_10 }}</td>
                <td>{{ form.sun_start_time_10 }}</td>
                <td>{{ form.sun_distance_10 }}</td>
                <td>{{ form.sun_duration_10 }}</td>
                <td><button type="button" class="remove-trip styled-red-button" data-trip-id="10">-</button></td>
            </tr>
        </tbody>
    </table>
    <br>
    <button type="button" id="add-trip" class="styled-green-button">+ Add trip</button>
    <br><br>

    <div class="inline-label-input">
        <label>{{ form.sun_last_trip.label }}</label>
        {{ form.sun_last_trip }}
    </div>
    <br><br>
</form>

<button style="float: right; margin-top: 2vh;" class="otree-btn-next btn btn-primary" >Next</button>



<div id="warningModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <p>Warning: The destination of your last trip is not "Home", but you have selected "Home" as your final destination.</p><br>
        <p>Please edit your trips so that your last destination matches where you end your day.</p>
    </div>
</div>



<style>
    #additional-trips-table-thead {
        display: none;
    }

    #additional-trips-table {
        width: 100%; /* Adjust width as needed */
        border-collapse: collapse; /* Ensure borders collapse properly */
    }

    #additional-trips-table th,
    #additional-trips-table td {
        padding: 10px;
        text-align: left;
        width: 20%; /* Adjust width as needed */
    }

    #additional-trips-table th {
        background-color: #f2f2f2; /* Example background color for headers */
    }

    .inline-label-input {
        display: flex;
        align-items: center;
        justify-content: flex-start;
    }

    .inline-label-input label {
        margin-right: 10px;
        margin-left: 0px;
    }

    .styled-green-button {
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 15px;
        font-size: 14px;
        cursor: pointer;
    }

    .styled-red-button {
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 8px 15px;
        font-size: 14px;
        cursor: pointer;
        margin-left: 10px;
    }

    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }

    .modal-content {
        background-color: #fefefe;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more or less, depending on screen size */
        max-width: 600px; /* Example maximum width */
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>


<script>
document.getElementById('add-trip').addEventListener('click', function() {
    if (!validateTrips(false)) {
        return;
    }

    const table = document.getElementById('additional-trips-table');
    const thead = document.getElementById('additional-trips-table-thead');

    // Find the first hidden row and display it
    let added = false;
    for (let i = 1; i <= 10; i++) {
        const row = document.getElementById('additional_trip_' + i);
        if (row.style.display === 'none') {
            row.style.display = 'table-row';
            added = true;
            break;
        }
    }

    // Display the thead if a trip has been added
    if (added) {
        thead.style.display = 'table-header-group'; // or 'table-row' depending on your design
    }

    // Toggle the add trip button visibility based on the number of visible rows
    const visibleRows = table.getElementsByTagName('tbody')[0].querySelectorAll('tr[style="display: table-row;"]');
    document.getElementById('add-trip').style.display = (visibleRows.length >= 10) ? 'none' : 'block';
});

document.querySelectorAll('.remove-trip').forEach(function(button) {
    button.addEventListener('click', function() {
        const tripId = button.getAttribute('data-trip-id');
        const tripRow = document.getElementById('additional_trip_' + tripId);
        tripRow.style.display = 'none';

        // Reset the values of the form fields
        const additionalTripElement = document.querySelector(`[name="sun_additional_trip_${tripId}"]`);
        const startTimeElement = document.querySelector(`[name="sun_start_time_${tripId}"]`);
        const durationElement = document.querySelector(`[name="sun_duration_${tripId}"]`);
        const distanceElement = document.querySelector(`[name="sun_distance_${tripId}"]`);

        if (additionalTripElement) additionalTripElement.value = '';
        if (startTimeElement) startTimeElement.value = '';
        if (durationElement) durationElement.value = '';
        if (distanceElement) distanceElement.value = '';

        // Check if there are still visible rows
        const table = document.getElementById('additional-trips-table');
        const visibleRows = table.getElementsByTagName('tbody')[0].querySelectorAll('tr[style="display: table-row;"]');
        if (visibleRows.length === 0) {
            document.getElementById('additional-trips-table-thead').style.display = 'none';
        }

        // Show the add-trip button if any row is hidden
        document.getElementById('add-trip').style.display = 'block';
    });
});

// Modal elements
const modal = document.getElementById("warningModal");
const closeModal = document.getElementsByClassName("close")[0];
let proceedAfterWarning = false;

closeModal.onclick = function() {
    modal.style.display = "none";
}

window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

document.querySelector('.otree-btn-next').addEventListener('click', function(event) {
    if (!validateTrips(true)) {
        event.preventDefault();
    }
});

function validateTrips(includeHomeCheck) {
    // Clear previous error messages
    const errorMessages = document.querySelectorAll('.error-message');
    errorMessages.forEach(function(errorMessage) {
        errorMessage.remove();
    });

    // Check if tue_first_trip is the same as participant.vars.mo_last_trip
    const sunFirstTrip = document.querySelector('[name="sun_first_trip"]').value;
    const satLastTrip = "{{ participant.vars.sat_last_trip }}";
    if (sunFirstTrip !== satLastTrip) {
        const errorDiv = document.createElement('div');
        errorDiv.classList.add('error-message'); // Add class to identify error messages
        errorDiv.style.color = 'red';
        errorDiv.innerText = 'Error: The starting location of your day must match the ending location of your previous day, which was {{ participant.vars.sat_last_trip }}.';
        document.querySelector('form').insertAdjacentElement('beforebegin', errorDiv);
        return false; // Stop further checks if the first trip doesn't match the last trip
    }

    // Check if all displayed rows have all fields filled in
    let allFieldsFilled = true;
    for (let i = 1; i <= 10; i++) {
        const row = document.getElementById('additional_trip_' + i);
        if (row.style.display === 'table-row') {
            const additionalTripElement = document.querySelector(`[name="sun_additional_trip_${i}"]`);
            const startTimeElement = document.querySelector(`[name="sun_start_time_${i}"]`);
            const durationElement = document.querySelector(`[name="sun_duration_${i}"]`);
            const distanceElement = document.querySelector(`[name="sun_distance_${i}"]`);

            if (!additionalTripElement.value || !startTimeElement.value || !durationElement.value || !distanceElement.value) {
                allFieldsFilled = false;
                break;
            }
        }
    }

    if (!allFieldsFilled) {
        // Display error message
        const errorDiv = document.createElement('div');
        errorDiv.classList.add('error-message'); // Add class to identify error messages
        errorDiv.style.color = 'red';
        errorDiv.innerText = 'Error: Please fill in all fields for the displayed trips.';
        document.querySelector('form').insertAdjacentElement('beforebegin', errorDiv);
        return false; // Stop further checks if not all fields are filled
    }

    // Log the chosen sun_start_time values and check for duplicates and order
    const startTimes = {};
    let hasDuplicate = false;
    let isOrdered = true;
    let isLogical = true;
    let previousEndTime = null;

    for (let i = 1; i <= 10; i++) {
        const startTimeElement = document.querySelector(`[name="sun_start_time_${i}"]`);
        const durationElement = document.querySelector(`[name="sun_duration_${i}"]`);
        if (startTimeElement && durationElement) {
            const startTimeValue = startTimeElement.value;
            const durationValue = parseInt(durationElement.value);
            if (startTimeValue) {
                console.log(`Start time for trip ${i}:`, startTimeValue);

                if (startTimes[startTimeValue]) {
                    hasDuplicate = true;
                } else {
                    startTimes[startTimeValue] = true;
                }

                const timeParts = startTimeValue.split(':');
                const currentTime = new Date();
                currentTime.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]), 0, 0);

                if (previousEndTime && currentTime <= previousEndTime) {
                    isLogical = false;
                }

                if (previousEndTime && currentTime < previousEndTime) {
                    isOrdered = false;
                }

                previousEndTime = new Date(currentTime.getTime() + durationValue * 60000); // Add duration to get end time
            }
        }
    }

    if (hasDuplicate || !isLogical || !isOrdered) {
        // Display error message
        const errorDiv = document.createElement('div');
        errorDiv.classList.add('error-message'); // Add class to identify error messages
        errorDiv.style.color = 'red';
        errorDiv.innerText = hasDuplicate
            ? 'Error: Duplicate start times are not allowed.'
            : (!isLogical ? 'Error: Each trip must start after the previous trip ends.'
                          : 'Error: Start times must be in increasing order.');
        document.querySelector('form').insertAdjacentElement('beforebegin', errorDiv);
        return false; // Stop further checks if there are time errors
    }

    if (includeHomeCheck) {
        // Check if the last additional trip is not "Home" but sun_last_trip is "Home"
        let lastTrip = null;
        for (let i = 10; i >= 1; i--) {
            const row = document.getElementById('additional_trip_' + i);
            if (row.style.display === 'table-row') {
                lastTrip = document.querySelector(`[name="sun_additional_trip_${i}"]`).value;
                break;
            }
        }

        const moLastTrip = document.querySelector('[name="sun_last_trip"]').value;

        if (lastTrip && lastTrip !== "Home" && moLastTrip === "Home") {
            modal.style.display = "block";
            return false;
        }
    }

    return true;
}


    // Prepopulate additional trips if they have initial values
    const initialTrips = {{ additional_trips|safe }};
    for (let i = 1; i <= 10; i++) {
        if (initialTrips[i-1]) {
            document.getElementById('additional_trip_' + i).style.display = 'table-row';
            document.getElementById('additional-trips-table-thead').style.display = 'table-header-group';
        }
    }


</script>


{% endblock %}